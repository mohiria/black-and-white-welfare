name: 自动领取CDK

on:
  # 定时任务：每6小时执行一次
  schedule:
    - cron: '0 */6 * * *'

  # 允许手动触发
  workflow_dispatch:

jobs:
  claim-cdk:
    runs-on: ubuntu-latest

    # 使用 GitHub Environment 管理环境变量
    environment: production

    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置 Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: 安装依赖
        run: |
          npm ci
          npx playwright install --with-deps chromium

      - name: 运行自动化脚本
        run: npm start
        env:
          # 从 Environment 中读取环境变量
          CDK_COOKIE_STRING: ${{ secrets.CDK_COOKIE_STRING }}
          AI_API_KEY: ${{ secrets.AI_API_KEY }}
          AI_REDEEM_URL: ${{ secrets.AI_REDEEM_URL }}

      - name: 上传截图（如果有错误）
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: error-screenshots
          path: |
            images/*.png
          retention-days: 7

      - name: 发送邮件通知（CDK兑换失败时）
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.MAIL_SERVER }}
          server_port: ${{ secrets.MAIL_PORT }}
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: '⚠️ CDK兑换失败通知'
          to: ${{ secrets.MAIL_TO }}
          from: ${{ secrets.MAIL_USERNAME }}
          body: |
            CDK兑换任务执行失败，请检查GitHub Actions日志。

            执行时间: ${{ github.event.repository.updated_at }}
            仓库: ${{ github.repository }}
            运行ID: ${{ github.run_id }}

            查看详情: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

